<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<title>slide example</title>
<style>
html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    overflow:hidden;
    background-color: #333;
}
ul, li {
    margin: 0;
    padding: 0;
    list-style-type: none;
}
#wrapper {
    width: 100%;
    height:100%;
    overflow:hidden;
    background-color: #333;
    position: relative;
}
.slide {
    height:100%;
}
.panel {
    position: relative;    
    background: url(http://m1.daumcdn.net/img-section/enter/common/loading.gif) 50% 50% no-repeat;
}
.btn {
    position: absolute;
    top: 45%;
    width: 58px;
    height: 58px;
    overflow: hidden;
    background-color: black;
    z-index: 2000;
    cursor: pointer;
    border: 1px solid #464646;
    text-align: center;
    opacity: 0.6; 
}
#prev-button {
    left: 10px;
}
#next-button{
    right: 10px;
}
.btn .ico {
    width: 16px;
    height: 30px;
    overflow: hidden;
    margin: 16px auto 0 auto;
    background: url(http://i1.daumcdn.net/img-section/enter/common/pv_icon1.png) 0 -30px no-repeat;
}
#next-button .ico {
    background-position: 0 -60px;
    width: 13px;
    margin-left: 24px;
}

#header {
    width: 100%;
    z-index: 999;
    position: absolute;
    top:0;
}

#footer {
    width: 100%;
    z-index: 999;
    position: absolute;
    bottom:0;
}

#title-wrap {
    position: absolute;
    bottom: 0;
    left: 0;
    z-index: 9999;
    width: 100%;
    display: none;
    background-color: black;
    color: white;
    text-align: center;
    letter-spacing: -1px;
}
#title-wrap .inner {
    margin: 13px;
}
#title-wrap .title {
    font: bold 16px dotum;
    color: white;
    text-decoration: none;
}
#title-wrap .bar {
    padding: 0 9px;
    font-size: 14px;
    color: #2E2F2A;
    position: relative;
    top: -2px;
}
#title-wrap .link {
    color: #9AF;
    font-size: 12px;
    position: relative;
    top: -2px;
}
#title-wrap .ico {
    padding: 0 0 0 3px;
}
#title-wrap .ico span {
    position: relative;
    top: 7px;
    padding: 0 0 0 5px;
    background: url(http://i1.daumcdn.net/img-section/enter/common/pv_icon1.png) 0 -90px no-repeat;
    overflow: hidden;
}

div.ps-caption {
    background: black;
    color: #9AF;
    font: bold 14px dotum;
    text-align: center;
    width: 100%!important;
    z-index: 9999!important;
}
.ps-caption-content {
    padding: 13px;
    display: block;
}
.ps-caption-content .count {
    color: white;
    font-size: 12px;
    font-weight: normal;
    padding-left: 3px;
}
.ps-caption-content .count em {
    color: #9AF;
    font-style: normal;
    font-size: 12px;
}
#close-button {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 70px;
    border-left: 1px solid #2F2F2F;
    cursor: pointer;
    text-align: center;
    background-color: black;
}
#close-button .ico {
    width: 25px;
    height: 23px;
    overflow: hidden;
    margin: 10px auto 0 auto;
    background: url(http://i1.daumcdn.net/img-section/enter/common/pv_icon1.png) 0 0 no-repeat;
}
</style>
<script type="text/javascript" src="http://east.ftdev.daum.net/g/js/gesture.js"></script>
    <script src="http://s1.daumcdn.net/svc/attach/U0301/cssjs/ejohn/class-0.1.0.min.js"></script>
<script type="text/javascript" src="js/datasource.js"></script>
<script type="text/javascript" src="js/observable.js"></script>
<script type="text/javascript" src="js/new_slide.js"></script>

</head>
<body>
<div id="wrapper"></div>
<div id="header">
    <div class="ps-caption" style="left: 0px; position: absolute; overflow-x: hidden; overflow-y: hidden; z-index: 1000; top: 0px; width: 1078px; opacity: 0.8; display: block; ">
        <div class="ps-caption-content"><span class="ps-title"></span><span class="count"></span></div>
        <div id="close-button"><div class="ico"></div></div>
    </div>
</div>
<div id="prev-button" class="btn"><div class="ico"></div></div>
<div id="next-button" class="btn"><div class="ico"></div></div>
<div id="footer"></div>
<script type="text/javascript">
var headTag = document.getElementsByTagName("head")[0],
    wrapper = document.getElementById("wrapper"),
    click = "ontouchstart" in window ? "touchstart" : "click",
    pageInfo = {
        initPage: 3, 
        initIndex: 0,
        numPerPage: 32,
        nextPage: 4,
        prevPage: 2
    },
    header = document.getElementById("header"),
    psTitle = header.getElementsByClassName("ps-title")[0],
    psCount = header.getElementsByClassName("count")[0],
    footer = document.getElementById("footer"),
    prevBtn = document.getElementById("prev-button"),
    nextBtn = document.getElementById("next-button"),
    closeBtn = document.getElementById("close-button"),
    totalCount = 0;

var simpleSearchAPICallback = null;
function simpleSearchAPIJsonp(page, callback) {
    simpleSearchAPICallback = callback;
    var url = 'http://media.daum.net/export/json/3165a129029c43ea8078217ae6ed99a2?photoId=2797&newsId=&page='+ page +'&countPerPage=100&callback=simpleJsonpCallback';
    var s = document.createElement("script");
    s.type = "text/javascript";
    s.src = url;
    s.charset = "utf-8";
    headTag.appendChild(s);
}
function simpleJsonpCallback(data) {
    headTag.removeChild(headTag.lastChild);
    simpleSearchAPICallback(data);
}

function loadInitialData(callback) {
    simpleSearchAPIJsonp(pageInfo.initPage, function (data) {
        psTitle.innerHTML = data.title;
        initSlide(data);
    });
}
function loadMoreData(page, callback) {
    simpleSearchAPIJsonp(page, function (data) {
        callback(data);
    });
}

var ImageSearchDataSource = slide.DataSource.extend({
    willQueryEndOfDataDelegate: function (callback) {
        var self = this;
        if (totalCount/pageInfo.numPerPage + 1 > pageInfo.nextPage) {
            loadMoreData(pageInfo.nextPage, function (data) {
                var newSlides = buildSlides(data);
                self.data = self.data.concat(newSlides);
                callback(newSlides[0]);
                pageInfo.nextPage++;
            });
        } else {
            callback(null);
        }
    },
    willQueryFirstOfDataDelegate: function (callback) {
        var self = this;
        if (pageInfo.prevPage > 0) {
            loadMoreData(pageInfo.prevPage, function (data) {
                var newSlides = buildSlides(data);
                self.setCurrentIndex(newSlides.length + self.index);
                self.data = newSlides.concat(self.data);
                callback(newSlides[0]);
                pageInfo.prevPage--;
            });
        } else {
            callback(null);
        }
    }
});

function initSlide(data) {
    wrapper.style.display = "block";
    ImgManager.setClientSize(wrapper);

    var ds = new ImageSearchDataSource(buildSlides(data));
    ds.setCurrentIndex(pageInfo.initIndex);
    var sl = new slide.Slide(wrapper, ds);

    prevBtn.addEventListener(click, function(){
        sl.prev();
    }, false);
    nextBtn.addEventListener(click, function(){
        sl.next();
    }, false);
    sl.on("resize", function () {
        ImgManager.setClientSize(wrapper);
        sl.show();
    });

    setDesc();
    sl.on("startDrag", function (session) {
        session.targetEvent.preventDefault();
    });
    sl.on("next", setDesc);
    sl.on("prev", setDesc);
        function setDesc () {
            ds.queryCurrent(function (data) {
                psCount.innerHTML = '(<em>'+((pageInfo.prevPage*pageInfo.numPerPage)+ds.index+1)+'</em>/'+totalCount+')';
                footer.innerHTML = createDesc(data);
            });
        }

    var viewState = "block";
    sl.on("click", function() {
        if (viewState === "none") {
            setDisplay("block");
        } else {
            setDisplay("none");
        }
    });
        function setDisplay (state) {
            header.style.display = state;
            footer.style.display = state;
            prevBtn.style.display = state;
            nextBtn.style.display = state;
            viewState = state;
        }
}

function onImgLoad (el) {
    var imgSize = ImgManager.resizeImg(el.naturalWidth, el.naturalHeight);
    var imgOffset = ImgManager.getImgOffset(imgSize.width, imgSize.height);
    
    el.style.cssText = 'width:'+imgSize.width+'px;height:'+imgSize.height+'px;top:'+imgOffset.top+'px;left:'+imgOffset.left+'px;position:absolute;';
};
function onImgLoadError (el) {
    el.parentNode.style.background = "none";
};

function buildSlides(data) {
    totalCount = data.count;
    var items = data.list.data,
        arr = [];
    for (var i = 0, len = items.length; i < len; i++) {
        var item = items[i];
        arr.push({
            id : item.id,
            image: item.image,
            summary: item.summary,
            title: item.title,
            toHTML: function () {
                var cdnImgUrl = this.image.replace("http://photo-media.daum-img.net","http://m1.daumcdn.net/photo-media");
                return '<img alt="'+escape(this.title)+'" src="'+cdnImgUrl+'" style="position:absolute;width:1px;height:1px;" onload="onImgLoad(this);" onerror="onImgLoadError(this);" onabort="onImgLoadError(this);">';
            }
        });
    }
    return arr;
}


function createDesc (data) {
    return '<div id="title-wrap" style="opacity: 0.8; display: block;">'
            + '<div class="inner">'
                + '<a href="http://newslink.media.daum.net/mobile/'+data.id+'" class="title">'+data.title+'</a>'
                + '<span class="bar">|</span>'
                + '<a href="http://newslink.media.daum.net/mobile/'+data.id+'" class="link">기사보기</a>'
                + '<span class="ico"><span></span></span>'
            + '</div>'
          + '</div>';
}

(function main() {
    window.addEventListener("load", function(e){
        loadInitialData();
    });
})();

var ImgManager = {
    clientWidth: 0,
    clientHeight: 0,
    setClientSize: function (el) {
        this.clientHeight = el.clientHeight - 10;
        this.clientWidth = el.clientWidth - 10;
    },
    resizeImg: function (width, height) {
        if (this.clientHeight > this.clientWidth) {
            return this.potraitResizeImg(width, height);
        } else {
            return this.landscapeResizeImg(width, height);
        }
    },
    potraitResizeImg: function (width, height) {
        if (this.clientWidth * height > this.clientHeight * width) {
            return this.resizeByHeight(width, height);
        } else {
            return this.resizeByWidth(width, height);
        }
    },
    landscapeResizeImg: function (width, height) {
        if (this.clientWidth * height < this.clientHeight * width) {
            return this.resizeByWidth(width, height);
        } else {
            return this.resizeByHeight(width, height);
        }
    },
    resizeByHeight: function (width, height) {
        return {width: parseInt(this.clientHeight * width / height), height: this.clientHeight};
    },
    resizeByWidth: function (width, height) {
        return {width: this.clientWidth, height: parseInt(this.clientWidth * height / width)};
    },
    getImgOffset: function (width, height) {
        return {left: parseInt((this.clientWidth + 10 - width) / 2), top: parseInt((this.clientHeight + 10 - height) / 2)};
    }
};
</script>

</body>
</html>